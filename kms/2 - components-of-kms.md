# Components of KMS

1. Customer Master Keys (CMK)
2. Data Encryption Keys (DEK)
3. Key Policies
4. Grants

## Customer Master Keys (CMK)
* Main key type in KMS
* Encrypts data up to 4KB
* Typically used in relation to DEKs
* Can generate, encrypt, and decrypt DEKs

There are two types of CMKs
* **AWS managed CMKs**
	* Used by other AWS services to encrypt data
	* Can only be used by the service that created the CMK
	* Created the first time you implement encryption using a service
* **Customer managed CMKs**
	* Can rotate, govern access and key policy all by yourself
	* Can enable/disable keys as needed
	* Can also be used by other AWS services
* **AWS Owned CMK**
	- Not visible in console or account
	- Cannot track or audit
	- Used for encrypting some data in your account
	- Example: S3 master key uses SSE-S3 encryption
	- Example: Default encryption option for DDB tables uses AWS owned keys

## Data Encryption Keys (DEK)
* Generated by a CMK
* Used for encrypting plaintext data of any size
* When data is encrypted, the DEK is also encrypted and stored alongside the encrypted data
	* So the payload is encrypted data + encrypted DEK
* The plain text DEK, that was generated by a CMK, is only stored in memory. So once encryption is done, the plain text DEK is lost
* The encrypted DEK can be decrypted to its plaintext key by using the CMK that generated the DEK. The (now-decrypted) DEK can be used to decrypt the encrypted data
* Quick Overview
	* Encryption:
		1. CMK generates a DEK and an encrypted DEK (this is just the DEK but encrypted)
		2. S3 would encrypt plaintext using DEK --> encrypted data
		3. S3 stores encrypted data + encrypted DEK = encrypted object
	* Decryption
		1. S3 sends encrypted DEK to CMK in order to decrypt for DEK
		2. S3 decrypts encrypted data with DEK
		3. S3 sends plaintext data back

## Key Policies
* Define who can use and access certain CMKs
* Key policies are *resource-based policies* because they are tied to CMKs
* Different policies can be created for different CMKs
* Permissions for a policy are defined in a JSON key policy file

## Grants
* Grants are a "resource-based" method of accessing control to CMKs
* Can only be created via API; **cannot be created in the console**
* Can delegate a subset of your own access/permissions to a CMK for principals
* Less risk of someone changing access control permissions for the associated CMK
* Eliminates possibily of **anyone** using the permission `kms:PutKeyPolicy`
* If a user wants to create a CMK, they must have permission to do so via the CMK's key policy
